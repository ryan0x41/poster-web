<script type="module" src="/js/main.js"></script>
<script type="importmap">
{
    "imports": {
        "axios": "https://cdn.skypack.dev/axios"
    }
}
</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root {
    --primary: #2f27ce;
    --icon-color: var(--primary);
    --secondary: #dedcff;
    --background: #000000;
    --light: #ffffff;
    --heading: #DDDBFF;
    --text: #9893D8;
    --sidebar-bg: #111111;
    --receiver-bg: var(--primary);
    --sender-bg: #222222;
    --foreground-bg: #1d1d1d;
    --spotify-green: #1DB954;
  }

  .hover-light:hover {
    color: #e0e0e0;
  }

  nav * {
    z-index: 3000 !important;
  }
</style>

<nav class="bg-[var(--sidebar-bg)] px-4 py-3 flex justify-between items-center">
  <div class="text-xl font-bold text-[var(--heading)]">poster</div>
  <div class="flex items-center space-x-4">
    <div class="relative inline-block text-left">
      <button id="notifications-button" type="button" class="relative flex items-center focus:outline-none">
        <i class="fas fa-bell text-[var(--icon-color)]"></i>
        <span id="notifications-badge"
          class="absolute top-0 right-0 inline-flex items-center justify-center px-1 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full"></span>
      </button>
      <div id="notifications-dropdown"
        class="origin-top-right absolute right-0 mt-2 w-64 rounded-md shadow-lg bg-[var(--secondary)] ring-1 ring-black ring-opacity-5 hidden">
        <div class="py-2 px-2" role="menu" aria-orientation="vertical" aria-labelledby="notifications-button">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-bold text-[var(--background)]">Notifications</span>
            <button id="read-all-button" class="text-xs text-blue-500 hover:underline">Read All</button>
          </div>
          <ul id="notifications-list">
            <li class="flex items-center justify-between py-1">
              <span class="text-[var(--background)] text-sm">Notification message 1</span>
              <button class="mark-read-btn text-green-500 text-xs">Mark as read</button>
            </li>
            <li class="flex items-center justify-between py-1">
              <span class="text-[var(--background)] text-sm">Notification message 2</span>
              <button class="mark-read-btn text-green-500 text-xs">Mark as read</button>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="relative inline-block text-left">
      <button id="menu-button" type="button" class="flex items-center focus:outline-none" aria-expanded="false"
        aria-haspopup="true">
        <img id="profile-picture" class="h-8 w-8 rounded-full"
          src="https://wallpapers.com/images/high/placeholder-profile-icon-20tehfawxt5eihco.png"
          alt="Profile Picture" />
        <svg class="ml-2 h-5 w-5 text-[var(--icon-color)]" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="dropdown-menu"
        class="origin-top-right absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-[var(--secondary)] ring-1 ring-black ring-opacity-5 hidden">
        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="menu-button">
          <a id="profile-link" href="#"
            class="block px-4 py-2 text-sm text-[var(--background)] hover:bg-[var(--sender-bg)] hover-light"
            role="menuitem">Profile</a>
          <a id="logout-button" href="#"
            class="block px-4 py-2 text-sm text-red-500 hover:bg-[var(--sender-bg)] hover-light"
            role="menuitem">Logout</a>
        </div>
      </div>
    </div>
  </div>
</nav>

<script>
  function getUserFromCookie() {
    const cookies = document.cookie.split('; ');
    const userCookie = cookies.find(cookie => cookie.startsWith('user='));
    if (!userCookie) return null;
    try {
      const encodedUserInfo = userCookie.split('=')[1];
      const decodedUserInfo = decodeURIComponent(encodedUserInfo);
      return JSON.parse(atob(decodedUserInfo));
    } catch (error) {
      console.error('error decoding user cookie:', error, encodedUserInfo);
      return null;
    }
  }

  function getUsername() {
    const user = getUserFromCookie();
    return user?.username;
  }

  function getUserId() {
    const user = getUserFromCookie();
    return user?.id;
  }

  function getAccountCreation() {
    const user = getUserFromCookie();
    return user?.accountCreation;
  }

  function getEmail() {
    const user = getUserFromCookie();
    return user?.email;
  }

  function userIsAdmin() {
    const user = getUserFromCookie();
    return user?.isAdmin;
  }

  function userSpotifyLinked() {
    const user = getUserFromCookie();
    return user?.spotifyLinked;
  }

  function getProfilePictureUrl() {
    const user = getUserFromCookie();
    return user?.profileImageUrl;
  }

  window.getUsername = getUsername;
  window.getUserId = getUserId;
  window.getAccountCreation = getAccountCreation;
  window.getEmail = getEmail;
  window.userIsAdmin = userIsAdmin;
  window.userSpotifyLinked = userSpotifyLinked;
  window.getProfilePictureUrl = getProfilePictureUrl;

  const menuButton = document.getElementById('menu-button');
  const dropdown = document.getElementById('dropdown-menu');
  const profilePicture = document.getElementById('profile-picture');
  const profileLink = document.getElementById('profile-link');
  const logoutButton = document.getElementById('logout-button');
  const notificationsButton = document.getElementById('notifications-button');
  const notificationsDropdown = document.getElementById('notifications-dropdown');
  const readAllButton = document.getElementById('read-all-button');

  function updateProfilePicture() {
    const profileUrl = getProfilePictureUrl();
    if (profileUrl) {
      profilePicture.src = profileUrl;
    }
  }

  function updateNotificationsBadge() {
    const notifications = document.querySelectorAll('#notifications-list li');
    const unreadCount = Array.from(notifications).filter(notification => !notification.classList.contains('read')).length;
    const badge = document.getElementById('notifications-badge');
    badge.textContent = unreadCount;
    badge.style.display = unreadCount > 0 ? 'inline-flex' : 'none';
  }

  profileLink.addEventListener('click', (e) => {
    e.preventDefault();
    const username = getUsername();
    if (username) {
      window.location.href = `/profile/${username}`;
    }
  });

  logoutButton.addEventListener('click', (e) => {
    e.preventDefault();
    logout();
    window.location.reload();
  });

  menuButton.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdown.classList.toggle('hidden');
  });

  notificationsButton.addEventListener('click', (e) => {
    e.stopPropagation();
    notificationsDropdown.classList.toggle('hidden');
  });

  readAllButton.addEventListener('click', () => {
    const notifications = document.querySelectorAll('#notifications-list li');
    notifications.forEach(notification => {
      notification.classList.add('read');
      const btn = notification.querySelector('.mark-read-btn');
      if (btn) btn.style.display = 'none';
    });
    updateNotificationsBadge();
  });

  document.querySelectorAll('.mark-read-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      const li = e.target.closest('li');
      li.classList.add('read');
      e.target.style.display = 'none';
      updateNotificationsBadge();
    });
  });

  window.addEventListener('click', () => {
    dropdown.classList.add('hidden');
    notificationsDropdown.classList.add('hidden');
  });

  updateProfilePicture();
  updateNotificationsBadge();
</script>